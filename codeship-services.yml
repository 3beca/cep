mongodb:
  image: mongo:4.2.0
  cached: true

app:
  build:
    dockerfile: ./deploy/Dockerfile.build
  encrypted_env_file: ./deploy/app.encrypted
  links:
    - mongodb
  environment:
    - MONGODB_URL=mongodb://mongodb:27017
  volumes:
    - ./:/var/www
  cached: true

docker:
  image: docker:dind
  add_docker: true
  volumes_from:
    - app
  encrypted_env_file: ./deploy/dockercfg.encrypted
  environment:
    - IMAGE_NAME=francescorivola/tribeca-cep

deploy:
  build:
    dockerfile: ./deploy/Dockerfile.deploy-ssh
    encrypted_args_file: ./deploy/deploy.encrypted
  encrypted_env_file: ./deploy/deploy.encrypted
  environment:
    - IMAGE_NAME=francescorivola/tribeca-cep
  volumes_from:
    - app
  cached: true